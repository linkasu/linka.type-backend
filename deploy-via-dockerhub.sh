#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Docker Hub
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-via-dockerhub.sh

set -e

DOCKER_IMAGE="bakaidov/linka-type-backend"
TAG="latest"
SERVER="linka.su"
REMOTE_USER="aacidov"
REMOTE_DIR="/home/linka.type-backend"

echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Docker Hub..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Docker Hub –¥–æ—Å—Ç—É–ø–µ–Ω
echo "üì° –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Docker Hub..."
if ! docker pull hello-world:latest >/dev/null 2>&1; then
    echo "‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Docker Hub"
    exit 1
fi

# –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
echo "üî® –°–æ–±–∏—Ä–∞—é Docker –æ–±—Ä–∞–∑..."
docker compose build --no-cache

# –¢–µ–≥–∏—Ä—É–µ–º –æ–±—Ä–∞–∑ –¥–ª—è Docker Hub
echo "üè∑Ô∏è –¢–µ–≥–∏—Ä—É—é –æ–±—Ä–∞–∑ –¥–ª—è Docker Hub..."
docker tag linka.type-backend:latest $DOCKER_IMAGE:$TAG

# –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üîê –ü—Ä–æ–≤–µ—Ä—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ Docker Hub..."
if ! docker info | grep -q "Username"; then
    echo "‚ö†Ô∏è –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ Docker Hub. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: docker login"
    echo "–ü—Ä–æ–¥–æ–ª–∂–∞—é –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Docker Hub..."
    UPLOAD_TO_HUB=false
else
    UPLOAD_TO_HUB=true
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Docker Hub (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã)
if [ "$UPLOAD_TO_HUB" = true ]; then
    echo "üì§ –ó–∞–≥—Ä—É–∂–∞—é –æ–±—Ä–∞–∑ –≤ Docker Hub..."
    docker push $DOCKER_IMAGE:$TAG
    echo "‚úÖ –û–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Docker Hub"
else
    echo "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é –∑–∞–≥—Ä—É–∑–∫—É –≤ Docker Hub"
fi

# –ö–æ–ø–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üìã –ö–æ–ø–∏—Ä—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp docker-compose.yml $REMOTE_USER@$SERVER:$REMOTE_DIR/
scp env.server.example $REMOTE_USER@$SERVER:$REMOTE_DIR/

# –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üîß –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh $REMOTE_USER@$SERVER << 'EOF'
cd ~/linka.type-backend

echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down 2>/dev/null || true

echo "üóëÔ∏è –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
docker images | grep linka | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true

echo "üì• –ó–∞–≥—Ä—É–∂–∞—é –æ–±—Ä–∞–∑ –∏–∑ Docker Hub..."
docker pull aacidov/linka-type-backend:latest

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
docker compose up -d

echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 15

echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker ps

echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose ps

echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
docker compose logs --tail=20 server
EOF

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://type-backend.$SERVER"

if [ "$UPLOAD_TO_HUB" = false ]; then
    echo ""
    echo "üí° –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Docker Hub –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   docker login"
    echo "   docker push $DOCKER_IMAGE:$TAG"
fi
