name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      FOLDER_ID: ${{ vars.FOLDER_ID }}
      CLOUD_ID: ${{ vars.CLOUD_ID }}
      SERVICE_ACCOUNT_ID: ${{ vars.SERVICE_ACCOUNT_ID }}
      REGISTRY_ID: ${{ vars.REGISTRY_ID }}
      CORE_API_CONTAINER_NAME: ${{ vars.CORE_API_CONTAINER_NAME }}
      REALTIME_CONTAINER_NAME: ${{ vars.REALTIME_CONTAINER_NAME }}
      SYNC_WORKER_CONTAINER_NAME: ${{ vars.SYNC_WORKER_CONTAINER_NAME }}
      YDB_ENDPOINT: ${{ secrets.YDB_ENDPOINT }}
      YDB_DATABASE: ${{ secrets.YDB_DATABASE }}
      YDB_TOKEN: ${{ secrets.YDB_TOKEN }}
      FIREBASE_PROJECT_ID: ${{ vars.FIREBASE_PROJECT_ID }}
      FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
      FIREBASE_CREDENTIALS_B64: ${{ secrets.FIREBASE_CREDENTIALS_B64 }}
      FEATURE_READ_SOURCE: ${{ vars.FEATURE_READ_SOURCE }}
      FEATURE_COHORT_PERCENT: ${{ vars.FEATURE_COHORT_PERCENT }}
      TTS_PROXY_ENABLED: ${{ vars.TTS_PROXY_ENABLED }}
      TTS_BASE_URL: ${{ vars.TTS_BASE_URL }}
      SYNC_POLL_INTERVAL: ${{ vars.SYNC_POLL_INTERVAL }}
      SYNC_STREAM_ENABLED: ${{ vars.SYNC_STREAM_ENABLED }}
      SYNC_STREAM_PATH: ${{ vars.SYNC_STREAM_PATH }}
      SYNC_STREAM_RECONNECT: ${{ vars.SYNC_STREAM_RECONNECT }}
      IMAGE_TAG: latest
      YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yc CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          export PATH="${HOME}/yandex-cloud/bin:${PATH}"
          echo "${HOME}/yandex-cloud/bin" >> "${GITHUB_PATH}"
          yc --version

      - name: Configure yc CLI
        run: |
          if [ -z "${YC_SERVICE_ACCOUNT_KEY}" ]; then
            echo "Missing YC_SERVICE_ACCOUNT_KEY secret." >&2
            exit 1
          fi
          printf '%s' "${YC_SERVICE_ACCOUNT_KEY}" > /tmp/sa-key.json
          yc config set service-account-key /tmp/sa-key.json
          if [ -n "${CLOUD_ID}" ]; then
            yc config set cloud-id "${CLOUD_ID}"
          fi
          if [ -n "${FOLDER_ID}" ]; then
            yc config set folder-id "${FOLDER_ID}"
          fi

      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for Yandex Container Registry
        run: yc container registry configure-docker

      - name: Build and push images
        run: |
          if [ -z "${REGISTRY_ID}" ]; then
            echo "Missing REGISTRY_ID." >&2
            exit 1
          fi
          REGISTRY_ID="${REGISTRY_ID}" IMAGE_TAG="${IMAGE_TAG}" ./scripts/build-images.sh

      - name: Deploy core-api
        run: |
          if [ -z "${FOLDER_ID}" ] || [ -z "${SERVICE_ACCOUNT_ID}" ] || [ -z "${REGISTRY_ID}" ] || [ -z "${YDB_ENDPOINT}" ] || [ -z "${YDB_DATABASE}" ] || [ -z "${FIREBASE_PROJECT_ID}" ]; then
            echo "Missing required core-api deployment environment variables." >&2
            exit 1
          fi
          CONTAINER_NAME="${CORE_API_CONTAINER_NAME:-linka-core-api}" \
          FOLDER_ID="${FOLDER_ID}" SERVICE_ACCOUNT_ID="${SERVICE_ACCOUNT_ID}" REGISTRY_ID="${REGISTRY_ID}" IMAGE_TAG="${IMAGE_TAG}" \
          YDB_ENDPOINT="${YDB_ENDPOINT}" YDB_DATABASE="${YDB_DATABASE}" YDB_TOKEN="${YDB_TOKEN}" \
          FIREBASE_PROJECT_ID="${FIREBASE_PROJECT_ID}" FIREBASE_DATABASE_URL="${FIREBASE_DATABASE_URL}" FIREBASE_CREDENTIALS_B64="${FIREBASE_CREDENTIALS_B64}" \
          FEATURE_READ_SOURCE="${FEATURE_READ_SOURCE}" FEATURE_COHORT_PERCENT="${FEATURE_COHORT_PERCENT}" \
          TTS_PROXY_ENABLED="${TTS_PROXY_ENABLED}" TTS_BASE_URL="${TTS_BASE_URL}" \
          ./scripts/deploy-core-api.sh

      - name: Deploy realtime
        run: |
          if [ -z "${FOLDER_ID}" ] || [ -z "${SERVICE_ACCOUNT_ID}" ] || [ -z "${REGISTRY_ID}" ] || [ -z "${YDB_ENDPOINT}" ] || [ -z "${YDB_DATABASE}" ] || [ -z "${FIREBASE_PROJECT_ID}" ]; then
            echo "Missing required realtime deployment environment variables." >&2
            exit 1
          fi
          CONTAINER_NAME="${REALTIME_CONTAINER_NAME:-linka-realtime}" \
          FOLDER_ID="${FOLDER_ID}" SERVICE_ACCOUNT_ID="${SERVICE_ACCOUNT_ID}" REGISTRY_ID="${REGISTRY_ID}" IMAGE_TAG="${IMAGE_TAG}" \
          YDB_ENDPOINT="${YDB_ENDPOINT}" YDB_DATABASE="${YDB_DATABASE}" YDB_TOKEN="${YDB_TOKEN}" \
          FIREBASE_PROJECT_ID="${FIREBASE_PROJECT_ID}" FIREBASE_CREDENTIALS_B64="${FIREBASE_CREDENTIALS_B64}" \
          ./scripts/deploy-realtime.sh

      - name: Deploy sync-worker
        run: |
          if [ -z "${FOLDER_ID}" ] || [ -z "${SERVICE_ACCOUNT_ID}" ] || [ -z "${REGISTRY_ID}" ] || [ -z "${YDB_ENDPOINT}" ] || [ -z "${YDB_DATABASE}" ] || [ -z "${FIREBASE_PROJECT_ID}" ] || [ -z "${FIREBASE_DATABASE_URL}" ]; then
            echo "Missing required sync-worker deployment environment variables." >&2
            exit 1
          fi
          CONTAINER_NAME="${SYNC_WORKER_CONTAINER_NAME:-linka-sync-worker}" \
          FOLDER_ID="${FOLDER_ID}" SERVICE_ACCOUNT_ID="${SERVICE_ACCOUNT_ID}" REGISTRY_ID="${REGISTRY_ID}" IMAGE_TAG="${IMAGE_TAG}" \
          YDB_ENDPOINT="${YDB_ENDPOINT}" YDB_DATABASE="${YDB_DATABASE}" YDB_TOKEN="${YDB_TOKEN}" \
          FIREBASE_PROJECT_ID="${FIREBASE_PROJECT_ID}" FIREBASE_DATABASE_URL="${FIREBASE_DATABASE_URL}" FIREBASE_CREDENTIALS_B64="${FIREBASE_CREDENTIALS_B64}" \
          SYNC_POLL_INTERVAL="${SYNC_POLL_INTERVAL}" SYNC_STREAM_ENABLED="${SYNC_STREAM_ENABLED}" SYNC_STREAM_PATH="${SYNC_STREAM_PATH}" SYNC_STREAM_RECONNECT="${SYNC_STREAM_RECONNECT}" \
          ./scripts/deploy-sync-worker.sh

      - name: Smoke test core-api
        run: |
          CONTAINER_NAME="${CORE_API_CONTAINER_NAME:-linka-core-api}"
          CORE_API_URL=$(yc serverless container get --name "${CONTAINER_NAME}" --folder-id "${FOLDER_ID}" --format json | jq -r '.url')
          if [ -z "${CORE_API_URL}" ] || [ "${CORE_API_URL}" = "null" ]; then
            echo "Failed to resolve CORE_API_URL." >&2
            exit 1
          fi
          curl -sSf "${CORE_API_URL}/" >/dev/null
          curl -sSf "${CORE_API_URL}/healthz" >/dev/null
