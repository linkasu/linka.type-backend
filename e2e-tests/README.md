# E2E Тесты для Linka Backend

Этот проект содержит полный набор end-to-end тестов для проверки функциональности Linka Backend API.

## Структура проекта

```
e2e-tests/
├── package.json           # Зависимости и скрипты
├── setup.js              # Настройка Jest и глобальных переменных
├── utils/
│   ├── api-client.js     # Клиент для работы с API
│   └── websocket-client.js # Клиент для WebSocket
├── tests/
│   ├── auth.test.js      # Тесты аутентификации
│   ├── categories.test.js # Тесты категорий
│   ├── statements.test.js # Тесты statements
│   ├── websocket.test.js # Тесты WebSocket
│   └── integration.test.js # Интеграционные тесты
└── env.example           # Пример файла окружения
```

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Скопируйте файл окружения:
```bash
cp env.example .env
```

3. Настройте переменные окружения в `.env`:
```bash
BASE_URL=http://localhost:8081
```

## Запуск тестов

### Запуск всех тестов
```bash
npm test
```

### Запуск с watch режимом
```bash
npm run test:watch
```

### Запуск с покрытием
```bash
npm run test:coverage
```

### Запуск конкретного теста
```bash
npm test -- --testNamePattern="should register new user"
```

### Запуск конкретного файла
```bash
npm test -- auth.test.js
```

## Подготовка к тестированию

1. Убедитесь, что сервер запущен:
```bash
docker-compose up -d
```

2. Дождитесь готовности сервера (проверьте health endpoint):
```bash
curl http://localhost:8081/api/health
```

## Что тестируется

### Аутентификация (auth.test.js)
- Регистрация пользователей
- Логин пользователей
- Получение профиля
- OTP функциональность
- Сброс пароля
- Валидация данных
- Обработка ошибок

### Категории (categories.test.js)
- CRUD операции с категориями
- Валидация данных
- Авторизация
- Изоляция данных между пользователями

### Statements (statements.test.js)
- CRUD операции с statements
- Связи с категориями
- Валидация данных
- Авторизация
- Изоляция данных

### WebSocket (websocket.test.js)
- Подключение к WebSocket
- Уведомления о создании/обновлении/удалении
- Изоляция уведомлений между пользователями
- Обработка переподключений

### Интеграционные тесты (integration.test.js)
- Полный пользовательский сценарий
- Многопользовательские сценарии
- Обработка ошибок
- Производительность
- Целостность данных

## Настройка окружения

### Переменные окружения

- `BASE_URL` - базовый URL сервера (по умолчанию: http://localhost:8081)
- `NODE_ENV` - окружение (по умолчанию: test)
- `JEST_TIMEOUT` - timeout для тестов (по умолчанию: 30000)

### Логирование

Тесты выводят подробные логи о запросах и ответах. Для отключения логирования измените уровень в setup.js.

## Отладка

### Запуск в режиме отладки
```bash
npm run test:debug
```

### Просмотр логов
Тесты автоматически логируют все HTTP запросы и WebSocket сообщения.

### Проверка состояния базы данных
```bash
docker exec linka-type-backend-db-1 psql -U postgres -d linkatype -c "SELECT * FROM users;"
```

## Известные ограничения

1. OTP тесты используют моковые коды, так как нет доступа к реальной почте
2. Некоторые тесты могут быть нестабильными при медленном соединении
3. WebSocket тесты требуют стабильного сетевого соединения

## Добавление новых тестов

1. Создайте новый файл в папке `tests/`
2. Импортируйте необходимые утилиты
3. Используйте глобальные функции `generateTestEmail()` и `generateTestPassword()`
4. Добавьте тесты в соответствующий describe блок

## Устранение неполадок

### Тесты не подключаются к серверу
- Проверьте, что сервер запущен: `docker-compose ps`
- Проверьте URL в `.env` файле
- Проверьте health endpoint: `curl http://localhost:8081/api/health`

### WebSocket тесты падают
- Проверьте, что WebSocket endpoint доступен
- Увеличьте timeout в тестах
- Проверьте логи сервера

### Тесты падают из-за таймаутов
- Увеличьте `JEST_TIMEOUT` в `.env`
- Проверьте производительность сервера
- Уменьшите количество параллельных операций
