Обязательные задачи перед продакшн-развёрткой

Секреты и конфигурация
- Вынести JWT-секрет из кода (auth/jwt.go) в переменную окружения JWT_SECRET; убрать значение по умолчанию.
- Исключить ./firebase.json из продакшн-образа; подключать volume.
- Отключить автоматическую загрузку .env в продакшн (fb/fb.go) или ограничить локальной средой.

Пароли и аутентификация
- Выполнить миграцию: поле password_hash, ре-хэш при логине или миграционный скрипт.
- Добавить rate limit на /auth/login, /auth/register, /auth/request_password_reset.
- Добавить refresh-токены и ротацию: access 15 минут, refresh 7-30 дней, отзыв при компрометации.

JWT и middleware
- Источник секрета только из окружения; длина не менее 256 бит; поддержать ротацию (kid, активный/предыдущий ключ).
- Добавить и проверять iss, aud, jti; сократить exp до 15 минут; проверять nbf/iat.
- Реализовать отзыв токенов (blacklist/allowlist по jti) при logout/инциденте.
- Унифицировать ответы об ошибках авторизации; не раскрывать детали.

WebSocket безопасность
- Ограничить CheckOrigin белым списком доменов, убрать return true в websocket/manager.go.
- Требовать валидный JWT при апгрейде, проверять срок, jti; писать аудит подключений.
- Ограничить размер и частоту сообщений; защитить от flood; задать ping/pong таймауты в конфиге.

OTP и почта
- Хранить OTP как хэш (HMAC с серверным секретом), не в открытом виде.
- Ввести одноразовость и лимиты попыток; TTL 10-15 минут; лимит генерации N/час на email/IP.
- Письма: не раскрывать лишние данные; включить DKIM/SPF/DMARC; убрать украшения из шаблонов для продакшн.
- Убедиться, что TEST_MODE=false в продакшн; не логировать SMTP-пароли.

База данных и миграции
- Включить SSL для PostgreSQL (sslmode=require) и параметризовать через окружение.
- Создать отдельного DB-пользователя с минимальными правами для приложения.
- Добавить миграции: users.password_hash, индексы на users.email и otp_codes (email,type,created_at),
  индексы (user_id,created_at) по основным таблицам.
- Настроить пул соединений: MaxOpenConns, MaxIdleConns, ConnMaxLifetime; health endpoints.

Контейнеризация и окружение
- Финальный образ: distroless/alpine с non-root пользователем; USER 10001; без shell.
- Конфиги только через env/secret; не копировать .env и firebase.json в образ.
- Подготовить docker-compose.prod.yml: изолированные сети, рестарт-политики, healthchecks, лимиты логов.

HTTP слой и роутинг
- Включить CORS с белым списком доменов; запретить звёздочку в продакшн.
- Включить rate limit, защита от slowloris; выставить Read/Write/Idle timeouts у сервера.
- Единая обработка ошибок; корреляционные идентификаторы в заголовках.
- Скрыть версионирование и лишние заголовки; включить сжатие с ограничениями.

Логирование, мониторинг, алерты
- Структурные логи (JSON), санитайз секретов; уровень логирования по окружению.
- Метрики (Prometheus/OpenTelemetry): RPS, ошибки, latency, пул БД, состояние WS.
- Алерты: рост 5xx, ошибки аутентификации, переполнения каналов WS, задержки БД.

Тесты и безопасность
- E2E: логин/регистрация, refresh flow, WS авторизация, OTP rate limit, политика паролей.
- Линтеры и SAST: gosec, staticcheck; регулярный audit зависимостей (govulncheck).
- Скан секретов в репозитории и образах; pre-commit хуки.

Политики и процедуры
- Политика ротации секретов (JWT/SMTP/DB) и хранение в Secret Manager.
- Процедура инцидент-реакции: отзыв токенов, принудительный logout, смена ключей.
- BCP/DR: бэкапы БД, шифрование, периодические тесты восстановления.

Документация и запуск
- Обновить документацию по переменным окружения, секретам, деплою и миграциям.
- Подготовить миграции и план отката; выполнить dry-run на staging.
- Проверить лицензии зависимостей; обновить уязвимые пакеты.

Минимальные правки по коду
- auth/jwt.go: убрать хардкод секрета, сократить срок токена, добавить iss/aud/jti.
- handlers/auth.go: заменить MD5 на bcrypt, ввест проверку силы пароля, продумать refresh flow.
- websocket/manager.go: ограничить CheckOrigin, добавить лимиты.
- db/connection.go: включить sslmode в продакшн, настроить пул.
- mail/mail.go: убрать лишние логи, следить за конфиденциальностью, выключить TEST_MODE.
- otp/otp.go и db/otp_crud.go: хранить OTP как хэш, ввести лимиты и attempts.

Убрать серверный порт, повксить на unix socket.

Чек-лист запуска продакшн
- Миграции БД выполнены, сделан бэкап.
- Секреты загружены в Secret Manager, окружение заполнено.
- Образ собран как non-root; SBOM и скан уязвимостей пройдены.
- Настроены CORS, RateLimit, Timeouts, Health, Метрики, Логи.
- E2E/регресс/нагрузка пройдены на staging.
- Мониторинг и алертинг включены.
